{% extends 'layout.html' %}

{% block content %}
<div class="timeline">
  {% if user %}
  <div>
    <form id="twit-form" action="/post" method="post" enctype="multipart/form-data">
      <div class="input-group">
        <textarea id="twit" name="content" maxlength="140"></textarea>
      </div>
      <div class="img-preview">
        <img id="img-preview" src="" style="display: none;" width="250" alt="미리보기">
        <input id="img-url" type="hidden" name="url">
      </div>
      <div>
        <label id="img-label" for="img">사진 업로드</label>
        <input id="img" type="file" accept="image/*">
        <button id="twit-btn" type="submit" class="btn">게시글 등록</button>
      </div>
    </form>
  </div>
  {% endif %}
  <div class="twits">
    <form id="hashtag-form" action="/hashtag">
      <input type="text" name="hashtag" class="serch_input" placeholder="태그 검색">
      <button class="btn serch_input">검색</button>
    </form>
    {% for twit in twits %}
    <div class="twit twit{{twit.id}}">
      <input type="hidden" value="{{twit.User.id}}" class="twit-user-id">
      <input type="hidden" value="{{twit.id}}" class="twit-id">
      {% if user and user.id == twit.User.id %}
      <button type="button" class="delete-twit btn" onclick="deleteTwit('{{twit.id}}')">삭제</button>
      {% endif %}
      {% if not followingIdList.includes(twit.User.id) and twit.User.id !== user.id %}
      <button class="twit-follow">팔로우</button>
      {% endif %}
      <div class="twit-author">{{twit.User.nick}}</div>
      
      {% if twit.img %}
      <div class="twit-img"><img src="{{twit.img}}" alt="섬네일"></div>
      {% endif %}
      <div class="twit-content">{{twit.content}}</div>
      <div class="comment_div" id="comment-open-{{twit.id}}">
        <button type="button" class="open-comment btn" onclick="openCommentList('{{twit.id}}')">O P E N</button>
      </div>
      <!-- 덧글 목록 표시   -->
      <div class="comment-section" id="comment-section-{{twit.id}}" style="display : none;">
        <div id="comment-list-{{twit.id}}"></div>

        <form class="comment-form">
          <div class="comment-form_div">
            <input class="comment-content" type="text" id="comment-content-{{twit.id}}" placeholder="댓글을 작성하세요"></input>
            <button type="button" class="btn" onclick="submitComment('{{twit.id}}')">댓글 작성</button>
          </div>
          <div>
            <button type="button" class="close-comment btn" onclick="hideCommentList('{{twit.id}}')">C L O S E</button>
          </div>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block script %}
<script>

  function deleteTwit(twitId) {
    const loggedinfo = document.querySelector('#my-id').value;
    axios.delete(`post/delete/${twitId}/${loggedinfo}`)
      .then((res) => {
        location.reload();
      })
      .catch((err) => {
        console.error(err);
      });
  };
  



  function deleteComment(commentId, commentorId, twitId) {
    const reqId = document.querySelector('#my-id').value;
    /* 로그인한 사용자 ,  덧글 작성자 ID , 서버에서 DB처리할 때 검증  */
    if (reqId === commentorId) {
      // 사용자 ID와 Commentor ID가 일치하는 경우에만 삭제 로직 실행
      axios.delete(`/comment/delete/${commentId}/${reqId}`)
        .then((res) => {
          console.log(res.data);
          openCommentList(twitId);
        })
        .catch((err) => {
          console.error(err);
        });
    } else {
      alert('댓글을 삭제할 권한이 없습니다.');
    }
  }

  function openCommentList(twitId) {
    document.getElementById(`comment-section-${twitId}`).style.display = 'block';
    document.getElementById(`comment-open-${twitId}`).style.display = 'none';
    axios.get(`comment/${twitId}`)
      .then((res) => {
        const commentListDiv = document.getElementById(`comment-list-${twitId}`);
        commentListDiv.innerHTML = "";
        
        res.data.forEach(comment => {
          const commentItem = document.createElement('div');
          commentItem.innerHTML = `
              <input type='hidden' value=${comment.id}>
              <span class="write_name">작성자 : ${comment.commentor}</span>
              <span>${comment.content}</span><br>
              <p class="write_date write_button">작성일: ${comment.createdAt}
                <button type="button" class="delete-comment btn" onclick="deleteComment('${comment.id}', '${comment.commentor}', '${twitId}')" style = "display : none;">댓글 삭제</button>
              </p>
              `;
          commentListDiv.appendChild(commentItem);    
          try {
            const myId = document.querySelector('#my-id').value;
            if (myId === `${comment.commentor}`) {
              commentItem.querySelector('.delete-comment').style.display = 'inline-block';
            } else {
              commentItem.querySelector('.delete-comment').style.display = 'none';
            }
          } catch (error) {
            console.error(error);
          };
        });
      })
      .catch((err) => {
        console.error(err);
      });
  }


  function hideCommentList(twitId) {
    document.getElementById(`comment-section-${twitId}`).style.display = 'none';
    document.getElementById(`comment-open-${twitId}`).style.display = 'block';
  };

  function submitComment(twitId) {
    const loggedinfo = document.querySelector('#my-id');
    if (loggedinfo) {
      const content = document.getElementById(`comment-content-${twitId}`).value;
      if (content == '') {
        alert("댓글을 입력해주세요");
        return;
      }
      axios.post(`/comment/${twitId}`, { content })
        .then((res) => {
          console.log(res.data);
          document.getElementById(`comment-content-${twitId}`).value = ""; // 댓글 작성 후, 입력값 초기화
          openCommentList(twitId);
        })
        .catch((err) => {
          console.error(err);
        });
    } else {
      alert('로그인을 해주세요!')
    }
  }


  if (document.getElementById('img')) {
    document.getElementById('img').addEventListener('change', function (e) {
      const formData = new FormData();
      console.log(this, this.files);
      formData.append('img', this.files[0]);
      axios.post('/post/img', formData)
        .then((res) => {
          document.getElementById('img-url').value = res.data.url;
          document.getElementById('img-preview').src = res.data.url;
          document.getElementById('img-preview').style.display = 'inline';
        })
        .catch((err) => {
          console.error(err);
        });
    });
  }
  document.querySelectorAll('.twit-follow').forEach(function (tag) {
    tag.addEventListener('click', function () {
      const myId = document.querySelector('#my-id');
      if (myId) {
        const userId = tag.parentNode.querySelector('.twit-user-id').value;
        if (userId !== myId.value) {
          if (confirm('팔로잉하시겠습니까?')) {
            axios.post(`/user/${userId}/follow`)
              .then(() => {
                location.reload();
              })
              .catch((err) => {
                console.error(err);
              });
          }
        }
      }
      else{
        alert("로그인 후 이용해 주세요.");
      }
    });
  });
</script>
{% endblock %}